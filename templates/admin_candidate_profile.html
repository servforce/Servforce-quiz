<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>候选人详情</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ui.css') }}" />
    <style>
      .container { max-width: 1200px; width: min(1200px, 100%); }
      /* Keep the white surface width consistent across views (even when content is empty). */
      #candidateProfileSurface { width: 100%; align-self: stretch; }
      /* Page tone: softer colors and clearer hierarchy (avoid all-black/bold look). */
      .surface[aria-label="候选人详情"] { color: #333; }
      .surface[aria-label="候选人详情"] .mutedv { color: rgba(51, 51, 51, 0.70); }
      .surface[aria-label="候选人详情"] .time { color: #080; font-weight: 800; }
      .head-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .head-row .title { margin: 0; line-height: 1.15; }
      .head-left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
      .head-meta {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 7px 12px;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.10);
        background: rgba(248, 250, 252, 0.75);
        font-weight: 800;
        font-size: 16px;
        color: rgba(15, 23, 42, 0.80);
      }
      /* Segmented control (looks like a pager-style switch, not 3 separate buttons). */
      .head-tabs {
        display: inline-flex;
        align-items: center;
        flex-wrap: nowrap;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(248, 250, 252, 0.80);
        padding: 4px;
        gap: 0;
      }
      .head-tab {
        appearance: none;
        border: 0;
        background: transparent;
        border-radius: 999px;
        height: 38px;
        padding: 0 16px;
        font-weight: 800;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        user-select: none;
        color: rgba(15, 23, 42, 0.72);
      }
      .head-tab:hover { background: rgba(15, 23, 42, 0.04); }
      .head-tab.active {
        background: rgba(37, 99, 235, 0.12);
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.18);
        color: rgba(15, 23, 42, 0.92);
      }
      .head-tab:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
      }
      .head-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      /* Make <button> and <a> look identical in the header actions. */
      .head-actions .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 46px;
        padding: 0 18px;
        line-height: 1;
        font-size: 16px;
        border-radius: 16px;
        text-decoration: none;
      }
      .head-actions .btn-icon {
        width: 46px;
        padding: 0;
      }
      .head-actions-main { display: inline-flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .btn-purple {
        background: linear-gradient(135deg, var(--brand2), #5b21b6);
        border-color: rgba(124, 58, 237, 0.45);
        color: #fff;
        font-weight: 900;
      }
      .btn-purple:hover { filter: brightness(1.03); text-decoration: none; }
      .btn-purple:active { transform: translateY(1px); }
      /* Editing is removed on this page; keep view layout only. */
      .input-sm {
        width: 100%;
        max-width: 380px;
        padding: 9px 10px;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.16);
        background: rgba(255, 255, 255, 0.92);
        font-weight: 800;
      }
      textarea.input-sm { max-width: 100%; min-height: 140px; }
      .table-mini {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      .table-mini th, .table-mini td {
        text-align: left;
        padding: 8px 8px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        vertical-align: top;
      }
      .table-mini th { font-size: 12px; font-weight: 900; background: rgba(248, 250, 252, 0.75); }
      .row-actions { display:flex; gap:8px; }
      .btn-mini { padding: 7px 10px; border-radius: 12px; font-weight: 900; }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(248, 250, 252, 0.75);
        font-weight: 800;
        font-size: 12px;
        color: rgba(15, 23, 42, 0.75);
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      .info-split {
        display: grid;
        grid-template-columns: 1.05fr 0.95fr;
        gap: 22px;
        align-items: start;
      }
      .info-right {
        padding-left: 22px;
        border-left: 1px solid rgba(15, 23, 42, 0.10);
      }
      .card {
        border: 1px solid rgba(15, 23, 42, 0.10);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.94);
        box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04);
        overflow: hidden;
      }
      .card-head {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: rgba(248, 250, 252, 0.75);
      }
      .card-title { font-weight: 900; letter-spacing: 0.2px; font-size: 17px; }
      .card-body { padding: 14px 16px; }
      .kv {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 8px 12px;
        align-items: start;
      }
      .k { font-weight: 700; font-size: 12px; color: rgba(51, 51, 51, 0.70); }
      .v { font-weight: 650; color: #333; }
      .mutedv { font-weight: 700; }
      .info-kv { display: grid; grid-template-columns: 120px 1fr; gap: 10px 16px; align-items: start; }
      .info-kv .k { font-size: 14px; white-space: nowrap; }
      .info-kv .v { font-size: 18px; letter-spacing: 0.1px; }
      .info-kv .v strong { font-weight: 800; }
      .eval {
        margin-top: 14px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.10);
        background: rgba(248, 250, 252, 0.85);
      }
      .eval-title { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 8px; }
      .eval-title .k { margin: 0; font-size: 12px; }
      .eval-body { font-weight: 750; line-height: 1.8; }
      .eng-title { color: rgba(15, 23, 42, 0.78); font-weight: 900; margin-bottom: 10px; }
      .eng-kv { display:grid; grid-template-columns: 120px 1fr; gap: 10px 14px; align-items: center; }
      .eng-kv .k { font-size: 12px; }
      .eng-kv .v { font-size: 14px; font-weight: 800; }
      .edu-item { padding: 10px 0; border-bottom: 1px dashed rgba(15, 23, 42, 0.12); }
      .edu-item:last-child { border-bottom: 0; }
      .edu-row {
        display: grid;
        grid-template-columns: 1fr max-content;
        column-gap: 38px;
        align-items: baseline;
      }
      .edu-main { min-width: 0; }
      .edu-mainline {
        display: inline-flex;
        gap: 10px;
        align-items: baseline;
        flex-wrap: wrap;
      }
      .edu-degree { font-weight: 900; }
      .edu-school { font-weight: 800; }
      .edu-major { font-weight: 700; }
      .edu-time { font-weight: 800; font-size: 16px; white-space: nowrap; color: #080; }
      .uni-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 900;
        letter-spacing: 0.2px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: #fff;
        white-space: nowrap;
      }
      .uni-badge--ivy {
        border-color: rgba(124, 58, 237, 0.35);
        background: rgba(124, 58, 237, 0.12);
        color: rgb(88, 28, 135) !important;
      }
      .uni-badge--985 {
        border-color: rgba(37, 99, 235, 0.35);
        background: rgba(37, 99, 235, 0.12);
        color: rgb(30, 64, 175) !important;
      }
      .uni-badge--211 {
        border-color: rgba(16, 185, 129, 0.35);
        background: rgba(16, 185, 129, 0.12);
        color: rgb(6, 95, 70) !important;
      }
      .projects { display: grid; gap: 10px; }
      .resume-raw {
        white-space: pre-wrap;
        word-break: break-word;
        font-family: inherit;
        font-weight: 650;
        color: rgba(15, 23, 42, 0.90);
        line-height: 1.75;
        margin: 0;
      }
      .attempt-results-table { width: 100%; table-layout: fixed; }
      .attempt-results-table th,
      .attempt-results-table td { padding-left: 12px; padding-right: 12px; }
      .attempt-results-table td.ellipsis { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .attempt-results-table th:nth-child(2),
      .attempt-results-table td:nth-child(2) { text-align: center; }
      .attempt-results-table th:nth-child(3),
      .attempt-results-table td:nth-child(3) { text-align: center; font-variant-numeric: tabular-nums; }
      .attempt-results-table th:nth-child(4),
      .attempt-results-table td:nth-child(4) { text-align: center; font-variant-numeric: tabular-nums; }
      .attempt-results-table th:nth-child(5),
      .attempt-results-table td:nth-child(5) { text-align: center; font-variant-numeric: tabular-nums; }
      .attempt-results-table tr.row-link { cursor: pointer; }
      .attempt-results-table tr.row-link:hover td { background: rgba(37, 99, 235, 0.06); }
      .proj {
        border: 1px solid rgba(15, 23, 42, 0.10);
        border-radius: 14px;
        background: rgba(248, 250, 252, 0.6);
        padding: 12px 12px;
      }
      .proj.eval-item { display: flex; flex-direction: column; }
      .proj-head { display:flex; align-items: baseline; justify-content: space-between; gap: 12px; }
      .proj-head--meta-only { justify-content: flex-end; }
      .proj-name { font-weight: 900; }
      .proj-meta { font-weight: 800; font-size: 14px; white-space: nowrap; color: #080; }
      .eval-foot {
        margin-top: auto;
        padding-top: 10px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        align-items: center;
      }
      .eval-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .eval-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(248, 250, 252, 0.75);
        font-weight: 900;
        font-size: 14px;
        line-height: 1;
        color: rgba(51, 51, 51, 0.92);
        white-space: nowrap;
      }
      .eval-tag.llm { border-color: rgba(37, 99, 235, 0.25); background: rgba(37, 99, 235, 0.10); color: rgb(30, 64, 175); }
      .eval-tag.admin { border-color: rgba(124, 58, 237, 0.22); background: rgba(124, 58, 237, 0.10); color: rgb(88, 28, 135); }
      .eval-time {
        text-align: right;
        font-weight: 800;
        font-size: 14px;
        white-space: nowrap;
        color: #080;
      }
      .proj-role { margin-top: 6px; font-weight: 800; font-size: 13px; color: rgba(15, 23, 42, 0.78); }
      .proj-desc { margin: 8px 0 0; padding-left: 18px; }
      .proj-desc li { margin: 6px 0; }
      .span2 { grid-column: 1 / -1; }
      @media (max-width: 980px) {
        .grid { grid-template-columns: 1fr; }
        .kv { grid-template-columns: 110px 1fr; }
        .edu-row { grid-template-columns: 1fr; row-gap: 6px; }
        .info-split { grid-template-columns: 1fr; }
        .info-right { padding-left: 0; border-left: 0; border-top: 1px solid rgba(15, 23, 42, 0.10); padding-top: 12px; }
        .info-kv { grid-template-columns: 120px 1fr; }
      }
      @media (max-width: 720px) {
        .head-tab { height: 36px; font-size: 14px; padding: 0 12px; }
        .head-actions .btn { height: 42px; font-size: 14px; padding: 0 14px; border-radius: 14px; }
        .head-actions .btn-icon { width: 42px; }
        .card-title { font-size: 16px; }
        .info-kv .v { font-size: 16px; }
        .edu-time { font-size: 14px; }
        .eval-tag { font-size: 13px; padding: 5px 10px; }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="Servforce Quiz 管理后台">
          <span class="brand-badge" aria-hidden="true"></span>
          <span>Servforce Quiz</span>
        </div>

        <nav class="nav" aria-label="主导航">
          <a class="nav-link" href="/admin#tab-exams">试卷管理</a>
          <a class="nav-link active" href="/admin/candidates">候选人管理</a>
          <a class="nav-link" href="/admin#tab-assign">答题邀请</a>
        </nav>

        <form method="post" action="/admin/logout" style="margin:0;">
          <button class="btn btn-danger" type="submit">退出</button>
        </form>
      </div>
    </header>

    <main class="container page">
      {% for m in get_flashed_messages() %}
      <div class="flash">{{ m }}</div>
      {% endfor %}

      <div class="surface admin-surface" role="region" aria-label="候选人详情" id="candidateProfileSurface">
        <section class="section">
            <div class="head-row">
            <div class="head-left">
              <div class="head-tabs" role="tablist" aria-label="候选人详情视图切换">
                <button class="head-tab active" type="button" data-view="resume" role="tab" aria-selected="true">#{{ c.id }} {{ c.name or '姓名' }}</button>
                <button class="head-tab" type="button" data-view="attempts" role="tab" aria-selected="false">答题结果</button>
                <button class="head-tab" type="button" data-view="evaluations" role="tab" aria-selected="false">评价</button>
              </div>
            </div>
            <div class="head-actions">
              <div class="head-actions-main" id="headActionsMain">
                {% if c.resume_size %}
                  <a class="btn btn-purple btn-icon" href="/admin/candidates/{{ c.id }}/resume/download" title="下载PDF" aria-label="下载PDF">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M7 2h7l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="2" />
                      <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" />
                      <path d="M12 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <path d="m9.5 15.5 2.5 2.5 2.5-2.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </a>
                {% else %}
                  <span class="btn btn-purple btn-icon" style="opacity:.55; pointer-events:none;" aria-label="暂无PDF可下载" title="暂无PDF可下载">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M7 2h7l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="2" />
                      <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" />
                    </svg>
                  </span>
                {% endif %}
                <form id="reparseForm" method="post" action="/admin/candidates/{{ c.id }}/resume/reparse" enctype="multipart/form-data" style="margin:0;">
                  <input id="reparseFile" type="file" name="file" accept=".pdf,.docx,.txt,.md,.png,.jpg,.jpeg,.webp,.bmp,.tif,.tiff" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" />
                  <button type="button" id="reparseBtn" class="btn btn-purple">上传简历并解析</button>
                </form>
              </div>
              <a class="btn btn-purple" href="/admin/candidates" id="backBtn">返回</a>
            </div>
          </div>
        </section>

        <section class="section">
          <div class="grid">
            <div class="card span2" data-view="resume">
              <div class="card-head">
                <div class="card-title">基本信息</div>
              </div>
              <div class="card-body">
                <div class="info-split">
                  <div>
                    <div class="info-kv">
                      <div class="k">姓名</div>
                      <div class="v">
                        <span class="view-only"><strong>{{ c.name }}</strong></span>
                      </div>
                      <div class="k">性别</div>
                      <div class="{{ 'mutedv' if not gender else 'v' }}">
                        <span class="view-only">{{ gender or '—' }}</span>
                      </div>
                      <div class="k">电话</div>
                      <div class="v">
                        <span class="view-only">{{ c.phone }}</span>
                      </div>
                      <div class="k">邮箱</div>
                      <div class="{{ 'mutedv' if not email else 'v' }}">
                        <span class="view-only">{{ email or '—' }}</span>
                      </div>
                    </div>
                    {% if details_status == 'failed' and details_error %}
                      <div style="margin-top:12px;">
                        <div class="k" style="margin-bottom:6px;">解析失败原因</div>
                        <div class="mutedv">{{ details_error }}</div>
                      </div>
                    {% endif %}
                  </div>

                  <div class="info-right">
                    <div class="info-kv">
                      <div class="k">最高学历</div>
                      <div class="{{ 'mutedv' if not highest_education else 'v' }}">
                        <span class="view-only"><strong>{{ highest_education or '—' }}</strong></span>
                      </div>
                      <div class="k">创建时间</div>
                      <div class="{{ 'mutedv' if not c.created_at else 'v' }}">
                        <span class="view-only time">{{ c.created_at.strftime("%Y-%m-%d %H:%M:%S") if c.created_at else '—' }}</span>
                      </div>
                      <div class="k">四级（CET-4）</div>
                      <div class="{{ 'mutedv' if not (english.cet4 and english.cet4.score) else 'v' }}">
                        <span class="view-only">{{ english.cet4.score if english.cet4 and english.cet4.score is not none else '—' }}</span>
                      </div>
                      <div class="k">六级（CET-6）</div>
                      <div class="{{ 'mutedv' if not (english.cet6 and english.cet6.score) else 'v' }}">
                        <span class="view-only">{{ english.cet6.score if english.cet6 and english.cet6.score is not none else '—' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card span2" data-view="resume">
              <div class="card-head">
                <div class="card-title">教育经历</div>
              </div>
              <div class="card-body">
                {% if educations and educations|length > 0 %}
                  {% for e in educations %}
                    <div class="edu-item">
                      <div class="edu-row">
                        <div class="edu-main">
                          <div class="edu-mainline">
                            <span class="edu-degree">{{ e.degree or '未知' }}</span>
                            <span class="edu-school">{{ e.school or '—' }}</span>
                            {% if e.school_tag %}
                              <span class="uni-badge uni-badge--{{ e.school_tag }}">{{ e.school_tag_label }}</span>
                            {% endif %}
                            {% if e.major %}<span class="edu-major">{{ e.major }}</span>{% endif %}
                          </div>
                        </div>
                        <div class="edu-time">
                          {{ (e.start or '—') }} ~ {{ (e.end or '—') }}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="mutedv">暂无教育经历信息（可能仍在解析中，或简历为扫描版无法抽取文本）。</div>
                {% endif %}
              </div>
            </div>

            <div class="card span2" data-view="resume">
              <div class="card-head">
                <div class="card-title">工作/项目经历</div>
              </div>
              <div class="card-body">
                {% if experience_blocks and experience_blocks|length > 0 %}
                  <div class="projects">
                    {% for p in experience_blocks %}
                      <div class="proj">
                        <div class="proj-head">
                          <div class="proj-name">{{ p.title }}</div>
                          <div class="proj-meta time">{{ p.period or '—' }}</div>
                        </div>
                        {% if p.body %}
                          <pre class="resume-raw" style="margin-top:10px;">{{ p.body }}</pre>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% elif projects_raw %}
                  <pre class="resume-raw">{{ projects_raw }}</pre>
                {% else %}
                  <div class="mutedv">暂无工作/项目经历信息（可能仍在解析中）。</div>
                {% endif %}
              </div>
            </div>

            <div class="card span2" data-view="attempts" style="display:none;">
              <div class="card-head">
                <div class="card-title">答题结果</div>
              </div>
              <div class="card-body">
                {% if attempt_results and attempt_results|length > 0 %}
                  <div class="table-scroll">
                    <table class="attempt-results-table" aria-label="答题结果列表">
                      <colgroup>
                        <col style="width: 8%;" />
                        <col style="width: 28%;" />
                        <col style="width: 10%;" />
                        <col style="width: 27%;" />
                        <col style="width: 27%;" />
                      </colgroup>
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>试卷</th>
                          <th>成绩</th>
                          <th>进入时间</th>
                          <th>提交时间</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for r in attempt_results %}
                        <tr class="row-link" data-href="{{ r.attempt_href }}">
                          <td>{{ r.no }}</td>
                          <td class="ellipsis">{{ r.exam_name }}</td>
                          <td>{{ r.score }}</td>
                          <td class="nowrap">{{ r.start_at }}</td>
                          <td class="nowrap">{{ r.end_at }}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="mutedv">暂无答题结果。</div>
                {% endif %}
              </div>
            </div>

            <div class="card span2" data-view="evaluations" style="display:none;">
              <div class="card-head">
                <div class="card-title">评价</div>
              </div>
              <div class="card-body">
                <div class="projects">
                  <div class="proj eval-item">
                    <div class="eval-head">
                      <span class="eval-tag llm">大模型评价</span>
                    </div>
                    {% if evaluation_llm %}
                      <pre class="resume-raw" style="margin-top:10px;">{{ evaluation_llm }}</pre>
                    {% else %}
                      <div class="mutedv">暂无大模型评价信息（可能仍在解析中）。</div>
                    {% endif %}
                    {% if c.resume_parsed_at %}
                      <div class="eval-foot">
                             <div class="eval-time time">{{ c.resume_parsed_at.strftime("%Y-%m-%d %H:%M:%S") }}</div>
                      </div>
                    {% endif %}
                  </div>

                  {% if admin_evaluations and admin_evaluations|length > 0 %}
                    {% for it in admin_evaluations %}
                      <div class="proj eval-item" style="background: rgba(255, 255, 255, 0.75);">
                        <div class="eval-head">
                          <span class="eval-tag admin">管理员评价</span>
                        </div>
                        <pre class="resume-raw" style="margin-top:10px;">{{ it.text }}</pre>
                        <div class="eval-foot">
                          {% if (it.at_display or it.at) %}
                             <div class="eval-time time">{{ it.at_display or it.at }}</div>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  {% endif %}

                  <div class="proj" style="background: rgba(255, 255, 255, 0.75);">
                    <form method="post" action="/admin/candidates/{{ c.id }}/evaluation/update" style="margin:0;">
                      <div class="eval-head" style="margin-bottom:10px;">
                        <span class="eval-tag admin">新增管理员评价</span>
                      </div>
                      <textarea class="input-sm" name="evaluation" placeholder="评价内容"></textarea>
                      <div style="margin-top:10px; display:flex; justify-content:flex-end;">
                        <button class="btn btn-purple" type="submit">保存</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <script>
      (function () {
        const reparseBtn = document.getElementById('reparseBtn');
        const reparseFile = document.getElementById('reparseFile');
        const reparseForm = document.getElementById('reparseForm');

        const setView = (v) => {
          const view = (v || 'resume').trim();
          document.querySelectorAll('.head-tab[data-view]').forEach((btn) => {
            const active = btn.getAttribute('data-view') === view;
            btn.classList.toggle('active', active);
            btn.setAttribute('aria-selected', active ? 'true' : 'false');
          });
          document.querySelectorAll('.card[data-view]').forEach((card) => {
            const show = card.getAttribute('data-view') === view;
            card.style.display = show ? '' : 'none';
          });

          // Only show upload/download actions on "resume" view.
          const actionsMain = document.getElementById('headActionsMain');
          if (actionsMain) actionsMain.style.display = view === 'resume' ? '' : 'none';
        };

        const hashView = () => {
          const h = String(window.location.hash || '').replace(/^#/, '').trim();
          if (h === 'attempts' || h === 'evaluations' || h === 'resume') return h;
          return 'resume';
        };
        setView(hashView());
        window.addEventListener('hashchange', () => setView(hashView()));
        document.querySelectorAll('.head-tab[data-view]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const v = btn.getAttribute('data-view') || 'resume';
            window.location.hash = v;
          });
        });

        if (reparseBtn && reparseFile && reparseForm) {
          reparseBtn.addEventListener('click', () => reparseFile.click());
          reparseFile.addEventListener('change', () => {
            if (!reparseFile.files || reparseFile.files.length <= 0) return;
            reparseBtn.disabled = true;
            reparseBtn.textContent = '解析中…';
            reparseForm.submit();
          });
        }

        // Navigate to attempt detail when clicking an attempt row.
        document.querySelectorAll('.attempt-results-table tr.row-link').forEach((row) => {
          const href = row.getAttribute('data-href');
          if (!href) return;
          row.addEventListener('click', () => {
            const sel = window.getSelection ? String(window.getSelection().toString() || '') : '';
            if (sel && sel.trim()) return;
            window.location.href = href;
          });
        });
      })();
    </script>
  </body>
</html>
