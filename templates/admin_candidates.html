<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>候选人管理</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ui.css') }}" />
    <style>
      .form-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; align-items: end; }
      .status-code { display: inline-block; white-space: nowrap; }
      @media (max-width: 980px) { .form-grid { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="Servforce Quiz 管理后台">
          <span class="brand-badge" aria-hidden="true"></span>
          <span>Servforce Quiz</span>
        </div>

        <nav class="nav" aria-label="主导航">
          <a class="nav-link" href="/admin#tab-exams">试卷</a>
          <a class="nav-link" href="/admin#tab-assign">分发</a>
          <a class="nav-link active" href="/admin/candidates">候选人</a>
        </nav>

        <form method="post" action="/admin/logout" style="margin:0;">
          <button class="btn btn-danger" type="submit">退出</button>
        </form>
      </div>
    </header>

    <main class="container page">
      {% for m in get_flashed_messages() %}
      <div class="flash">{{ m }}</div>
      {% endfor %}

      <div class="surface" role="region" aria-label="候选人管理">
        <section class="section">
          <div class="section-head">
            <div>
              <h2 class="title">候选人管理</h2>
              <p class="sub">维护候选人信息，用于分发前的身份验证与状态跟踪。</p>
            </div>
            <a class="btn btn-primary" href="/admin#tab-assign">返回分发</a>
          </div>

          <form method="post" action="/admin/candidates">
            <div class="form-grid">
              <div class="field">
                <label for="name">姓名</label>
                <input id="name" class="input" name="name" placeholder="2-20位中文/英文，可含空格/·" required pattern="[\u4e00-\u9fffA-Za-z·\\s]{2,20}" title="2-20位中文/英文，可含空格/·" />
              </div>
              <div class="field">
                <label for="phone">手机号</label>
                <input id="phone" class="input" name="phone" placeholder="11位中国大陆手机号（支持 +86 前缀）" required pattern="1[3-9][0-9]{9}" title="11位中国大陆手机号（可输入 +86 前缀，后端会自动处理）" inputmode="numeric" />
              </div>
              <div>
                <button class="btn btn-primary" type="submit">创建候选人</button>
              </div>
            </div>
          </form>

          <form method="post" action="/admin/candidates/upload" enctype="multipart/form-data" style="margin-top: 12px;">
            <div class="form-grid">
              <div class="field" style="grid-column: span 2;">
                <label for="xlsx">批量导入（Excel .xlsx）</label>
                <input id="xlsx" class="input" type="file" name="file" accept=".xlsx" required />
              </div>
              <div style="align-self: end;">
                <button class="btn btn-primary" type="submit">上传导入</button>
              </div>
            </div>
            <p class="sub" style="margin-top: 6px;">表头支持 name/phone/exam_key 或 姓名/手机号/试卷（可选）；无表头时按前 3 列读取。</p>
          </form>
        </section>

        <section class="section">
          <div class="section-head">
            <div>
              <h3 class="title" style="font-size:16px;">候选人列表</h3>
              <p class="sub">状态：已创建 / 已分发 / 已验证 / 已完成。</p>
            </div>
            <form method="get" action="/admin/candidates" style="margin:0; display:flex; gap:10px; align-items:end;">
              <div class="field" style="min-width: 260px;">
                <label for="q">搜索</label>
                <input id="q" class="input" name="q" value="{{ q or '' }}" placeholder="姓名/手机号" />
              </div>
              <button class="btn" type="submit">查询</button>
            </form>
          </div>

          <table aria-label="候选人列表">
            <thead>
              <tr>
                <th style="width:70px;">ID</th>
                <th style="width:140px;">姓名</th>
                <th style="width:160px;">电话</th>
                <th style="width:170px;">创建时间</th>
                <th style="width:160px;">试卷</th>
                <th style="width:140px;">状态</th>
                <th style="width:80px;">成绩</th>
                <th style="width:170px;">进入时间</th>
                <th style="width:170px;">提交时间</th>
                <th style="width:80px;">面试</th>
                <th style="width:140px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for c in candidates %}
              {% set created = c.created_at %}
              {% set started = c.exam_started_at %}
              {% set submitted = c.exam_submitted_at %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.name }}</td>
                <td>{{ c.phone }}</td>
                <td>{{ created.strftime("%Y-%m-%d %H:%M:%S") if created else "" }}</td>
                <td><code>{{ c.exam_key or "" }}</code></td>
                {% set status_map = {'created':'已创建','distributed':'已分发','verified':'已验证','finished':'已完成'} %}
                <td><code class="status-code">{{ status_map.get(c.status, c.status) }}</code></td>
                <td>{{ c.score }}</td>
                <td>{{ started.strftime("%Y-%m-%d %H:%M:%S") if started else "" }}</td>
                <td>{{ submitted.strftime("%Y-%m-%d %H:%M:%S") if submitted else "" }}</td>
                <td>{{ "是" if c.interview else "否" }}</td>
                <td style="white-space: nowrap;">
                  <a class="btn" href="/admin/candidates/{{ c.id }}/attempt">查看</a>
                  <a class="btn" href="/admin/candidates/{{ c.id }}/edit">编辑</a>
                  <form method="post" action="/admin/candidates/{{ c.id }}/delete" style="display:inline; margin:0;" onsubmit="return confirm('确认删除该候选人？');">
                    <button class="btn btn-danger" type="submit">删除</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          {% if total_pages and total_pages > 1 %}
          <div class="flex" style="justify-content: space-between; margin-top: 12px;">
            <div class="sub" style="margin:0;">共 {{ total }} 人 · 第 {{ page }} / {{ total_pages }} 页</div>
            <div class="flex">
              {% if page > 1 %}
                <a class="btn" href="{{ url_for('admin_candidates', q=q, page=page-1) }}">上一页</a>
              {% endif %}
              {% if page < total_pages %}
                <a class="btn" href="{{ url_for('admin_candidates', q=q, page=page+1) }}">下一页</a>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </section>
      </div>
    </main>
  </body>
</html>
