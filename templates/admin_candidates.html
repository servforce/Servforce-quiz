<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>候选人管理</title>
      <link rel="stylesheet" href="{{ url_for('static', filename='ui.css') }}" />
      <style>
      .form-grid {
        display: grid;
        /* Let inputs stretch to consume available space so buttons stay near the phone input. */
        grid-template-columns: minmax(220px, 1fr) minmax(260px, 1fr) max-content max-content;
        gap: 10px;
        align-items: end;
        justify-content: start;
        max-width: 100%;
        width: 100%;
      }
      /* Keep “创建候选人” and “上传简历” buttons exactly same size. */
      .form-grid #candidateCreateForm .btn.btn-primary,
      .form-grid #resumePickBtn.btn.btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        padding: 0 16px;
        line-height: 1;
        font-size: 14px;
        border-radius: 14px;
      }
      /* Avoid nested forms: let form children participate in the grid. */
      .form-grid form { display: contents; }
      .status-code { display: inline-block; white-space: nowrap; }
      .search-inline { display:flex; flex-wrap: wrap; align-items: flex-end; gap: 10px; margin: 0; width: 100%; }
      .search-inline .field { margin: 0; flex: 1 1 240px; }
      .search-inline .field.field-q { flex: 0 1 420px; max-width: 420px; }
      .search-inline .field.field-sm { flex: 0 0 190px; }
      /* Ensure date inputs match the text input height (hard requirement). */
      .search-inline .input {
        height: 40px;
        padding-top: 0;
        padding-bottom: 0;
        line-height: 38px;
      }
      .range-group { display: flex; align-items: flex-end; gap: 10px; }
      .range-group .field { flex: 1 1 190px; }
      .range-sep {
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 2px;
        color: rgba(15, 23, 42, 0.55);
        font-weight: 900;
        user-select: none;
      }
      /* Custom date-display to avoid locale-mixed "日" in native date input text while keeping picker. */
      .date-proxy { position: relative; width: 100%; }
      .date-proxy .date-display { padding-right: 42px; cursor: pointer; }
      .date-proxy .date-native {
        position: absolute;
        left: 0;
        top: 0;
        width: 1px;
        height: 1px;
        opacity: 0;
        pointer-events: none;
      }
      .date-proxy .date-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.92);
        cursor: pointer;
        padding: 0;
      }
      .date-proxy .date-btn:hover { background: rgba(15, 23, 42, 0.04); }
      /* Make query/reset buttons look like the top "创建候选人/上传简历" buttons. */
      .search-inline .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        padding: 0 16px;
        line-height: 1;
        font-size: 14px;
        border-radius: 14px;
        text-decoration: none;
      }
      .search-inline a.btn:hover { text-decoration: none; }
      .btn-icon {
        min-width: 64px;
        padding: 9px 12px;
        text-align: center;
        font-size: 18px;
        line-height: 1;
      }
      .resume-name {
        margin-top: 6px;
        font-size: 13px;
        color: rgba(15, 23, 42, 0.72);
        max-width: 220px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .resume-upload-cell { display: flex; align-items: center; }
      /* Put chosen filename under the upload button without affecting the button-row height. */
      .form-grid #resumeFileName {
        grid-column: 4;
        grid-row: 2;
      }
      .cand-actions { display: inline-flex; gap: 10px; align-items: center; justify-content: flex-end; }
      .cand-actions .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 44px;
        padding: 0 16px;
        font-size: 16px;
        font-weight: 900;
        border-radius: 14px;
        line-height: 1;
      }
      .cand-actions .btn-icon {
        min-width: 44px;
        width: 44px;
        padding: 0;
        font-size: 20px;
      }

      /* Make Candidate Management font scale match Exams Management (admin dashboard). */
      .admin-surface { font-size: 16px; }
      .admin-surface .title { font-size: 22px; letter-spacing: 0.2px; }
      .admin-surface .field label { font-size: 16px; font-weight: 800; color: rgba(15, 23, 42, 0.78); }
      .admin-surface .input,
      .admin-surface select {
        height: 40px;
        padding-top: 0;
        padding-bottom: 0;
        line-height: 38px;
        font-size: 17px;
      }
      .form-grid #candidateCreateForm .btn.btn-primary,
      .form-grid #resumePickBtn.btn.btn-primary { font-size: 16px; }
      .search-inline .btn { font-size: 16px; }
      .date-proxy .date-btn { width: 32px; height: 32px; right: 8px; }
      table.cands-table { font-size: 19px; }
      table.cands-table th { font-size: 17px; }
      .resume-name { font-size: 14px; }

      /* Keep header/body columns perfectly aligned: use fixed table layout + colgroup widths. */
      table.cands-table { table-layout: fixed; }
      /* Center Resume header/value so they sit on the same vertical line (like “题数 / 62”). */
      table.cands-table th:nth-child(5),
      table.cands-table td:nth-child(5) { text-align: center; }
      table.cands-table th:last-child,
      table.cands-table td:last-child { text-align: right; }
      tr.row-link { cursor: pointer; }
      tr.row-link:hover td { background: rgba(37, 99, 235, 0.06); }
      @media (max-width: 980px) {
        .form-grid { grid-template-columns: 1fr; max-width: 100%; }
        .form-grid #resumeFileName { grid-column: 1; grid-row: auto; }
        .search-inline .field.field-q { flex: 1 1 100%; max-width: 100%; }
        .search-inline .field.field-sm { flex: 1 1 100%; }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="Servforce Quiz 管理后台">
          <span class="brand-badge" aria-hidden="true"></span>
          <span>Servforce Quiz</span>
        </div>

        <nav class="nav" aria-label="主导航">
          <a class="nav-link" href="/admin#tab-exams"><span class="nav-ico exams" aria-hidden="true"></span>试卷管理</a>
          <a class="nav-link active" href="/admin/candidates"><span class="nav-ico candidates" aria-hidden="true"></span>候选人管理</a>
          <a class="nav-link" href="/admin#tab-assign"><span class="nav-ico assign" aria-hidden="true"></span>答题邀请</a>
          <a class="nav-link" href="/admin#tab-logs"><span class="nav-ico logs" aria-hidden="true"></span>系统日志</a>
          {% set _ss = system_status_summary if system_status_summary else {} %}
          {% set _lvl = _ss.overall_level if _ss and _ss.overall_level else 'ok' %}
          {% set _badge = '' %}
          {% set _r_llm = ((_ss.get('llm') or {}).get('ratio') or 0.0) if _ss else 0.0 %}
          {% set _r_sms = ((_ss.get('sms') or {}).get('ratio') or 0.0) if _ss else 0.0 %}
          {% set _r_max = _r_llm if _r_llm > _r_sms else _r_sms %}
          {% set _pct = (_r_max * 100) | round(0) | int %}
          {% if _pct > 100 %}{% set _pct = 100 %}{% endif %}
          {% if _lvl != 'ok' %}{% set _badge = _pct ~ '%' %}{% endif %}
          <a class="nav-link" href="/admin#tab-status"><span class="nav-ico status" aria-hidden="true"></span>系统状态
            <span class="status-badge level-{{ _lvl }}" data-system-status-badge>{{ _badge }}</span>
          </a>
        </nav>

        <form method="post" action="/admin/logout" style="margin:0;">
          <button class="btn btn-danger" type="submit">退出</button>
        </form>
      </div>
    </header>

    <main class="container page" style="max-width:1080px;">
      {% for m in get_flashed_messages() %}
      {% if m and (m|string)|trim %}
      <div class="flash">{{ m }}</div>
      {% endif %}
      {% endfor %}

      <div class="surface admin-surface" role="region" aria-label="候选人管理">
        <section class="section">
          <div class="section-head">
            <div>
              <h2 class="title">候选人管理</h2>
              <p class="sub"></p>
            </div>
          </div>

          <div class="form-grid">
            <form id="candidateCreateForm" method="post" action="/admin/candidates">
              <div class="field">
                <label for="name">姓名</label>
                <input id="name" class="input" name="name" placeholder="2-20位中文/英文，可含空格/·" required pattern="[\u4e00-\u9fffA-Za-z·\\s]{2,20}" title="2-20位中文/英文，可含空格/·" />
              </div>
              <div class="field">
                <label for="phone">手机号</label>
                <input id="phone" class="input" name="phone" placeholder="11位中国大陆手机号（支持 +86 前缀）" required pattern="1[3-9][0-9]{9}" title="11位中国大陆手机号（可输入 +86 前缀，后端会自动处理）" inputmode="numeric" />
              </div>
              <div>
                <button class="btn btn-primary" type="submit">创建候选人</button>
              </div>
            </form>
            <form id="resumeUploadForm" method="post" action="/admin/candidates/resume/upload" enctype="multipart/form-data">
              <div class="resume-upload-cell">
                <input id="resumeFile" class="input" type="file" name="file" accept=".pdf,.docx,.txt,.md,.png,.jpg,.jpeg,.webp,.bmp,.tif,.tiff" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" />
                <button id="resumePickBtn" class="btn btn-primary" type="button">上传简历</button>
              </div>
              <div id="resumeFileName" class="resume-name" title=""></div>
            </form>
          </div>

        </section>

        <section class="section">
          <div class="section-head">
            <form class="search-inline" method="get" action="/admin/candidates">
              <div class="field field-q">
                <label for="q">候选人列表</label>
                 <input id="q" class="input" name="q" value="{{ q or '' }}" placeholder="ID/姓名/手机号" autocomplete="off" />
              </div>
              <div class="range-group">
                <div class="field field-sm">
                  <label for="created_from">创建时间(起)</label>
                  <div class="date-proxy">
                    <input id="created_from_display" class="input date-display" type="text" value="" placeholder="yyyy/mm/dd" readonly />
                    <input id="created_from" class="input date-native" type="date" name="created_from" value="{{ created_from or '' }}" tabindex="-1" aria-hidden="true" />
                    <button class="date-btn" type="button" data-for="created_from" aria-label="选择创建时间(起)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M8 2v3M16 2v3M3.5 9h17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M6.5 5h11A3 3 0 0 1 20.5 8v11a3 3 0 0 1-3 3h-11a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3z" stroke="currentColor" stroke-width="2" />
                      </svg>
                    </button>
                  </div>
                </div>
                <div class="range-sep" aria-hidden="true">—</div>
                <div class="field field-sm">
                  <label for="created_to">创建时间(止)</label>
                  <div class="date-proxy">
                    <input id="created_to_display" class="input date-display" type="text" value="" placeholder="yyyy/mm/dd" readonly />
                    <input id="created_to" class="input date-native" type="date" name="created_to" value="{{ created_to or '' }}" tabindex="-1" aria-hidden="true" />
                    <button class="date-btn" type="button" data-for="created_to" aria-label="选择创建时间(止)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M8 2v3M16 2v3M3.5 9h17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M6.5 5h11A3 3 0 0 1 20.5 8v11a3 3 0 0 1-3 3h-11a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3z" stroke="currentColor" stroke-width="2" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              <div>
                <button class="btn btn-primary" type="submit">查询</button>
              </div>
              <div>
                <a class="btn btn-primary" href="/admin/candidates">重置</a>
              </div>
            </form>
          </div>

          <div class="table-scroll">
            <table class="cands-table" aria-label="候选人列表">
              <colgroup>
                <col style="width: 90px;" />
                <col style="width: 20%;" />
                <col style="width: 24%;" />
                <col style="width: 22%;" />
                <col style="width: 22%;" />
                <col style="width: 170px;" />
              </colgroup>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>姓名</th>
                  <th>电话</th>
                  <th>创建时间</th>
                  <th>简历</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for c in candidates %}
                {% set created = c.created_at %}
                <tr class="row-link" data-href="/admin/candidates/{{ c.id }}">
                  <td>{{ c.id }}</td>
                  <td>{{ c.name }}</td>
                  <td>{{ c.phone }}</td>
                  <td>{{ created.strftime("%Y-%m-%d %H:%M:%S") if created else "" }}</td>
                  <td>
                    {% if c.has_resume %}
                      <code class="status-code">已上传</code>
                    {% else %}
                      <span class="status-code" style="color: var(--muted);">无</span>
                    {% endif %}
                  </td>
                  <td style="white-space: nowrap;">
                    <div class="cand-actions">
                      <form method="post" action="/admin/candidates/{{ c.id }}/delete" style="display:inline; margin:0;" onsubmit="return confirm('确认删除该候选人？');">
                        <button class="btn btn-danger" type="submit">删除</button>
                      </form>
                      <a class="btn btn-primary btn-icon" href="/admin?assign_candidate_id={{ c.id }}#tab-assign" title="创建答题邀请" aria-label="创建答题邀请">+</a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% set total_pages_display = total_pages if total_pages and total_pages > 0 else 1 %}
          <div class="tri-pager" aria-label="候选人分页">
            <span class="page-info">第 {{ page }} / {{ total_pages_display }} 页（共 {{ total }} 条）</span>
            {% if page > 1 %}
              <a class="tri-btn" href="/admin/candidates?page={{ page - 1 }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if created_from %}&created_from={{ created_from|urlencode }}{% endif %}{% if created_to %}&created_to={{ created_to|urlencode }}{% endif %}" aria-label="上一页" title="上一页">▲</a>
            {% else %}
              <span class="tri-btn disabled" aria-hidden="true">▲</span>
            {% endif %}
            {% if page < total_pages_display %}
              <a class="tri-btn" href="/admin/candidates?page={{ page + 1 }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if created_from %}&created_from={{ created_from|urlencode }}{% endif %}{% if created_to %}&created_to={{ created_to|urlencode }}{% endif %}" aria-label="下一页" title="下一页">▼</a>
            {% else %}
              <span class="tri-btn disabled" aria-hidden="true">▼</span>
            {% endif %}
          </div>
        </section>
      </div>
    </main>

    <script>
      // Live fuzzy search (debounced) for candidates.
      const qInput = document.getElementById("q");
      if (qInput && qInput.form) {
        let t = null;
        qInput.addEventListener("input", () => {
          if (t) window.clearTimeout(t);
          t = window.setTimeout(() => {
            const v = (qInput.value || "").trim();
            const u = new URL(window.location.href);
            if (v) u.searchParams.set("q", v);
            else u.searchParams.delete("q");
            u.searchParams.delete("page");
            window.location.href = u.toString();
          }, 300);
        });
      }

      // Resume upload: pick file and auto-submit.
      const resumePickBtn = document.getElementById("resumePickBtn");
      const resumeFile = document.getElementById("resumeFile");
      const resumeFileName = document.getElementById("resumeFileName");
      const resumeUploadForm = document.getElementById("resumeUploadForm");
      if (resumePickBtn && resumeFile) {
        resumePickBtn.addEventListener("click", () => resumeFile.click());
        resumeFile.addEventListener("change", () => {
          const f = resumeFile.files && resumeFile.files.length > 0 ? resumeFile.files[0] : null;
          if (resumeFileName) {
            resumeFileName.textContent = f ? (f.name || "已选择文件") : "";
            resumeFileName.title = resumeFileName.textContent || "";
          }
          if (!f || !resumeUploadForm) return;
          if (typeof f.size === "number" && f.size > 10 * 1024 * 1024) {
            alert("文件超过10MB，请重新上传");
            try { resumeFile.value = ""; } catch (e) {}
            if (resumeFileName) {
              resumeFileName.textContent = "";
              resumeFileName.title = "";
            }
            return;
          }
          try {
            resumePickBtn.disabled = true;
            resumePickBtn.textContent = "解析中…";
          } catch (e) {}
          resumeUploadForm.submit();
        });
      }

      // Navigate to edit page when clicking a row.
      document.querySelectorAll("tr.row-link").forEach((row) => {
        const href = row.getAttribute("data-href");
        if (!href) return;
        row.addEventListener("click", () => {
          const sel = window.getSelection ? String(window.getSelection().toString() || "") : "";
          if (sel && sel.trim()) return;
          window.location.href = href;
        });
      });

	      // Don't allow action buttons to trigger row navigation.
	      document.querySelectorAll(".cand-actions").forEach((el) => {
	        el.addEventListener("click", (e) => e.stopPropagation());
	      });

        // Date range: keep native date picker but display unified yyyy/mm/dd text (avoid locale-mixed "日").
        const fmtYmdSlash = (v) => {
          const s = String(v || "").trim();
          if (!s) return "";
          // native date input returns YYYY-MM-DD.
          const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          if (m) return `${m[1]}/${m[2]}/${m[3]}`;
          return s.replaceAll("-", "/");
        };
        const initDateProxy = (id) => {
          const native = document.getElementById(id);
          const display = document.getElementById(`${id}_display`);
          if (!native || !display) return;

          const sync = () => {
            display.value = fmtYmdSlash(native.value);
          };
          sync();
          native.addEventListener("change", sync);

          const open = () => {
            try {
              if (typeof native.showPicker === "function") native.showPicker();
              else native.click();
            } catch (e) {
              try { native.focus(); } catch (e2) {}
            }
          };
          display.addEventListener("click", open);
        };
        initDateProxy("created_from");
        initDateProxy("created_to");
        document.querySelectorAll("button.date-btn[data-for]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-for");
            const native = id ? document.getElementById(id) : null;
            if (!native) return;
            try {
              if (typeof native.showPicker === "function") native.showPicker();
              else native.click();
            } catch (e) {
              try { native.focus(); } catch (e2) {}
            }
          });
        });
	    </script>
      <script src="{{ url_for('static', filename='system_status.js') }}"></script>
	  </body>
	</html>
