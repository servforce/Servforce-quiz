<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>候选人管理</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ui.css') }}" />
    <style>
      .form-grid {
        display: grid;
        grid-template-columns: 280px 280px max-content;
        gap: 10px;
        align-items: end;
        justify-content: start;
        max-width: 980px;
        width: 100%;
      }
      .status-code { display: inline-block; white-space: nowrap; }
      .search-inline { display:flex; align-items: flex-end; gap: 10px; margin: 0; max-width: 360px; width: 100%; }
      .search-inline .field { margin: 0; width: 100%; }
      .btn-icon {
        min-width: 64px;
        padding: 9px 12px;
        text-align: center;
        font-size: 18px;
        line-height: 1;
      }
      .cand-actions { display: inline-flex; gap: 10px; align-items: center; justify-content: flex-end; }
      .cand-actions .btn { padding: 7px 10px; font-weight: 800; }
      .cand-actions .btn-icon { min-width: 44px; padding: 7px 0; }
      @media (max-width: 980px) {
        .form-grid { grid-template-columns: 1fr; max-width: 100%; }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="Servforce Quiz 管理后台">
          <span class="brand-badge" aria-hidden="true"></span>
          <span>Servforce Quiz</span>
        </div>

        <nav class="nav" aria-label="主导航">
          <a class="nav-link" href="/admin#tab-exams">试卷管理</a>
          <a class="nav-link active" href="/admin/candidates">候选人管理</a>
          <a class="nav-link" href="/admin#tab-assign">答题邀请</a>
        </nav>

        <form method="post" action="/admin/logout" style="margin:0;">
          <button class="btn btn-danger" type="submit">退出</button>
        </form>
      </div>
    </header>

    <main class="container page">
      {% for m in get_flashed_messages() %}
      <div class="flash">{{ m }}</div>
      {% endfor %}

      <div class="surface" role="region" aria-label="候选人管理">
        <section class="section">
          <div class="section-head">
            <div>
              <h2 class="title">候选人管理</h2>
              <p class="sub">维护候选人信息，用于答题邀请前的身份验证与状态跟踪。</p>
            </div>
          </div>

          <form method="post" action="/admin/candidates">
            <div class="form-grid">
              <div class="field">
                <label for="name">姓名</label>
                <input id="name" class="input" name="name" placeholder="2-20位中文/英文，可含空格/·" required pattern="[\u4e00-\u9fffA-Za-z·\\s]{2,20}" title="2-20位中文/英文，可含空格/·" />
              </div>
              <div class="field">
                <label for="phone">手机号</label>
                <input id="phone" class="input" name="phone" placeholder="11位中国大陆手机号（支持 +86 前缀）" required pattern="1[3-9][0-9]{9}" title="11位中国大陆手机号（可输入 +86 前缀，后端会自动处理）" inputmode="numeric" />
              </div>
              <div>
                <button class="btn btn-primary" type="submit">创建候选人</button>
              </div>
            </div>
          </form>

          <form method="post" action="/admin/candidates/upload" enctype="multipart/form-data" style="margin-top: 12px;">
            <div class="form-grid">
              <div class="field" style="grid-column: span 2;">
                <label for="xlsx">批量导入（Excel .xlsx）</label>
                <input id="xlsx" class="input" type="file" name="file" accept=".xlsx" required />
              </div>
              <div style="align-self: end;">
                <button class="btn btn-primary" type="submit">上传导入</button>
              </div>
            </div>
          </form>
        </section>

        <section class="section">
          <div class="section-head">
            <form class="search-inline" method="get" action="/admin/candidates">
              <div class="field">
                <label for="q">候选人列表</label>
                <input id="q" class="input" name="q" value="{{ q or '' }}" placeholder="姓名/手机号" autocomplete="off" />
              </div>
            </form>
          </div>

          <table aria-label="候选人列表">
            <thead>
              <tr>
                <th style="width:70px;">ID</th>
                <th style="width:160px;">姓名</th>
                <th style="width:180px;">电话</th>
                <th style="width:190px;">创建时间</th>
                <th style="width:140px;">状态</th>
                <th style="width:220px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for c in candidates %}
              {% set created = c.created_at %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.name }}</td>
                <td>{{ c.phone }}</td>
                <td>{{ created.strftime("%Y-%m-%d %H:%M:%S") if created else "" }}</td>
                {% set status_map = {'created':'已创建','distributed':'已分发','verified':'已验证','finished':'已完成'} %}
                <td><code class="status-code">{{ status_map.get(c.status, c.status) }}</code></td>
                <td style="white-space: nowrap;">
                  <div class="cand-actions">
                    <a class="btn" href="/admin/candidates/{{ c.id }}/edit">编辑</a>
                    <form method="post" action="/admin/candidates/{{ c.id }}/delete" style="display:inline; margin:0;" onsubmit="return confirm('确认删除该候选人？');">
                      <button class="btn btn-danger" type="submit">删除</button>
                    </form>
                    <a class="btn btn-primary btn-icon" href="/admin?assign_candidate_id={{ c.id }}#tab-assign" title="创建答题邀请" aria-label="创建答题邀请">+</a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          {% if total_pages and total_pages > 1 %}
          <div class="flex" style="justify-content: space-between; margin-top: 12px;">
            <div class="sub" style="margin:0;">共 {{ total }} 人 · 第 {{ page }} / {{ total_pages }} 页</div>
            <div class="flex">
              {% if page > 1 %}
                <a class="btn" href="{{ url_for('admin_candidates', q=q, page=page-1) }}">上一页</a>
              {% endif %}
              {% if page < total_pages %}
                <a class="btn" href="{{ url_for('admin_candidates', q=q, page=page+1) }}">下一页</a>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </section>
      </div>
    </main>

    <script>
      // Live fuzzy search (debounced) for candidates.
      const qInput = document.getElementById("q");
      if (qInput && qInput.form) {
        let t = null;
        qInput.addEventListener("input", () => {
          if (t) window.clearTimeout(t);
          t = window.setTimeout(() => {
            const v = (qInput.value || "").trim();
            const u = new URL(window.location.href);
            if (v) u.searchParams.set("q", v);
            else u.searchParams.delete("q");
            u.searchParams.delete("page");
            window.location.href = u.toString();
          }, 300);
        });
      }
    </script>
  </body>
</html>
