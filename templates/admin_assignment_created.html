<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>答题邀请已生成</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ui.css') }}" />
    <style>
      /* Match the screenshot: larger white surface (page size unchanged, only this view). */
      .container { max-width: 1080px; width: min(1080px, 100%); }
      .card-mini { border: 1px solid rgba(15, 23, 42, 0.12); border-radius: 12px; padding: 14px; background: rgba(15, 23, 42, 0.02); }
      .linkbox { padding: 10px 12px; border: 1px solid rgba(15, 23, 42, 0.12); border-radius: 12px; background: rgba(255, 255, 255, 0.92); word-break: break-all; }
      .qr { display: grid; place-items: center; padding: 10px; background: rgba(255, 255, 255, 0.92); border: 1px solid rgba(15, 23, 42, 0.12); border-radius: 12px; }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* Layout per sketch: center QR, right copy-QR; bottom link, right copy-link. */
      .invite-layout {
        width: 100%;
        display: grid;
        /* Keep link width same as QR block width. */
        grid-template-columns: min(520px, 100%) max-content;
        grid-auto-rows: max-content;
        gap: 14px 16px;
        align-items: stretch;
        justify-content: center;
      }
      .qr-card {
        width: 100%;
        min-height: 340px;
        display: grid;
        place-items: center;
      }
      .qr-card .qr { width: min(380px, 100%); }
      .qr-card img { width: 300px; height: 300px; }
      .invite-layout .linkbox { width: 100%; }
      .copy-btn {
        min-width: 132px;
        justify-self: end;
        align-self: end; /* bottom-right of its row */
      }

      /* Ensure the white surface fills the viewport height (more like the screenshot). */
      /* Make the white surface match the "red-frame" size (narrower than the container). */
      #inviteSurface {
        width: min(900px, 100%);
        margin: 0 auto;
        min-height: calc(100vh - 64px - 18px - 36px);
      }
      #inviteBody { flex: 1 1 auto; }

      @media (max-width: 980px) {
        .invite-layout { grid-template-columns: 1fr; justify-content: stretch; }
        .copy-btn { width: 100%; }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="Servforce Quiz 管理后台">
          <span class="brand-badge" aria-hidden="true"></span>
          <span>Servforce Quiz</span>
        </div>

        <nav class="nav" aria-label="主导航">
          <a class="nav-link" href="/admin#tab-exams"><span class="nav-ico exams" aria-hidden="true"></span>试卷管理</a>
          <a class="nav-link" href="/admin/candidates"><span class="nav-ico candidates" aria-hidden="true"></span>候选人管理</a>
          <a class="nav-link active" href="/admin#tab-assign"><span class="nav-ico assign" aria-hidden="true"></span>答题邀请</a>
          <a class="nav-link" href="/admin#tab-logs"><span class="nav-ico logs" aria-hidden="true"></span>系统日志</a>
          {% set _ss = system_status_summary if system_status_summary else {} %}
          {% set _lvl = _ss.overall_level if _ss and _ss.overall_level else 'ok' %}
          {% set _badge = '' %}
          {% set _r_llm = ((_ss.get('llm') or {}).get('ratio') or 0.0) if _ss else 0.0 %}
          {% set _r_sms = ((_ss.get('sms') or {}).get('ratio') or 0.0) if _ss else 0.0 %}
          {% set _r_max = _r_llm if _r_llm > _r_sms else _r_sms %}
          {% set _pct = (_r_max * 100) | round(0) | int %}
          {% if _pct > 100 %}{% set _pct = 100 %}{% endif %}
          {% if _lvl != 'ok' %}{% set _badge = _pct ~ '%' %}{% endif %}
          <a class="nav-link" href="/admin#tab-status"><span class="nav-ico status" aria-hidden="true"></span>系统状态
            <span class="status-badge level-{{ _lvl }}" data-system-status-badge>{{ _badge }}</span>
          </a>
        </nav>

        <form method="post" action="/admin/logout" style="margin:0;">
          <button class="btn btn-danger" type="submit">退出</button>
        </form>
      </div>
    </header>

    <main class="container page">
      <div class="surface" role="region" aria-label="答题邀请已生成" id="inviteSurface">
        <section class="section">
          <div class="section-head">
            <div>
              <h2 class="title">答题邀请已生成</h2>
              <p class="sub">链接与二维码已生成，可复制链接发送给候选人。</p>
            </div>
            <a class="btn btn-primary" href="/admin#tab-assign">返回答题邀请</a>
          </div>
        </section>

        <section class="section" id="inviteBody">
          <div class="invite-layout">
            <div class="card-mini qr-card" aria-label="邀请二维码">
              <div class="qr">
                <img src="/admin/qr/{{ token }}.png" width="300" height="300" alt="答题二维码" />
              </div>
              <div id="qrUrlText" class="sr-only">/admin/qr/{{ token }}.png</div>
            </div>
            <button class="btn btn-primary copy-btn" type="button" data-copy-qr="/admin/qr/{{ token }}.png" data-copy-qr-fallback="#qrUrlText">复制二维码</button>

            <div class="linkbox" id="inviteUrl">{{ url }}</div>
            <button class="btn btn-primary copy-btn" type="button" data-copy="#inviteUrl">复制链接</button>
          </div>
        </section>
      </div>
    </main>

    <script>
      async function copyText(text) {
        const t = String(text || "").trim();
        if (!t) return;
        try {
          await navigator.clipboard.writeText(t);
        } catch (_e) {
          const ta = document.createElement("textarea");
          ta.value = t;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
      }

      async function copyTextFrom(selector) {
        const el = document.querySelector(selector);
        if (!el) return;
        await copyText(el.textContent || "");
      }

      async function copyQrImage(path, fallbackSelector) {
        const url = new URL(String(path || ""), window.location.origin).toString();
        try {
          const r = await fetch(url, { credentials: "same-origin" });
          const blob = await r.blob();
          if (navigator.clipboard && window.ClipboardItem) {
            await navigator.clipboard.write([new ClipboardItem({ [blob.type || "image/png"]: blob })]);
            return;
          }
        } catch (_e) {}
        const el = fallbackSelector ? document.querySelector(fallbackSelector) : null;
        await copyText((el && el.textContent ? el.textContent : url) || "");
      }

      for (const btn of document.querySelectorAll("[data-copy]")) {
        btn.addEventListener("click", () => copyTextFrom(btn.dataset.copy));
      }
      for (const btn of document.querySelectorAll("[data-copy-qr]")) {
        btn.addEventListener("click", () => copyQrImage(btn.dataset.copyQr, btn.dataset.copyQrFallback || ""));
      }
    </script>
    <script src="{{ url_for('static', filename='system_status.js') }}"></script>
  </body>
</html>
