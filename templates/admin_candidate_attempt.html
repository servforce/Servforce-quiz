<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>答题回看</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ui.css') }}" />
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [["$", "$"], ["\\(", "\\)"]],
          displayMath: [["$$", "$$"], ["\\[", "\\]"]],
        },
        options: { skipHtmlTags: ["script", "noscript", "style", "textarea", "pre", "code"] },
      };
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
      .q { border: 1px solid rgba(15, 23, 42, 0.12); border-radius: 14px; padding: 12px; margin: 12px 0; background: rgba(15, 23, 42, 0.02); }
      .q.ok { border-color: rgba(22, 163, 74, 0.35); background: rgba(22, 163, 74, 0.06); }
      .q.bad { border-color: rgba(220, 38, 38, 0.30); background: rgba(220, 38, 38, 0.05); }
      .md { white-space: normal; }
      .md img { max-width: 100%; height: auto; border-radius: 10px; display:block; margin: 10px 0; }
      .ans { margin-top: 10px; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(15, 23, 42, 0.10); background: rgba(255, 255, 255, 0.92); }
      .opt { display:flex; gap: 10px; align-items: baseline; padding: 6px 8px; border-radius: 10px; }
      .opt.ok { background: rgba(22, 163, 74, 0.12); }
      .opt.bad { background: rgba(220, 38, 38, 0.10); }
      .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; font-weight: 900; font-size: 12px; border: 1px solid rgba(15,23,42,0.12); background: rgba(255,255,255,0.92); }
      .pill.ok { border-color: rgba(22, 163, 74, 0.30); color: #166534; background: rgba(22, 163, 74, 0.10); }
      .pill.bad { border-color: rgba(220, 38, 38, 0.25); color: #991b1b; background: rgba(220, 38, 38, 0.08); }
      pre.code { white-space: pre-wrap; margin: 0; }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="Servforce Quiz 管理后台">
          <span class="brand-badge" aria-hidden="true"></span>
          <span>Servforce Quiz</span>
        </div>
        <nav class="nav" aria-label="主导航">
          <a class="nav-link" href="/admin#tab-exams">试卷管理</a>
          <a class="nav-link" href="/admin/candidates">候选人管理</a>
          <a class="nav-link active" href="/admin#tab-assign">答题邀请</a>
        </nav>
        <form method="post" action="/admin/logout" style="margin:0;">
          <button class="btn btn-danger" type="submit">退出</button>
        </form>
      </div>
    </header>

    <main class="container page">
      {% for m in get_flashed_messages() %}
      <div class="flash error">{{ m }}</div>
      {% endfor %}

      <div class="surface" role="region" aria-label="答题回看">
        <section class="section">
          <div class="section-head">
            <div>
              <h2 class="title">答题回看</h2>
              <p class="sub">
                候选者：<code>{{ archive.candidate.name }}</code> <code>{{ archive.candidate.phone }}</code>
                · 试卷：<code>{{ archive.exam.exam_key }}</code>
                {% if archive.total_score is not none %}
                  · 总分：<b>{{ archive.total_score }}</b>/100
                {% endif %}
              </p>
            </div>
            <a
              class="btn btn-primary"
              href="{{ back_url or '/admin#tab-assign' }}"
              onclick="if (window.history && history.length > 1) { history.back(); return false; }"
            >返回</a>
          </div>
        </section>

        <section class="section">
          {% for q in archive.questions %}
            {% set score = q.score %}
            {% set mx = q.score_max %}
            {% set ok = (score is not none and mx is not none and (score|int) >= (mx|int)) %}
            <div class="q {{ 'ok' if ok else 'bad' }}">
              <div class="flex" style="justify-content: space-between; align-items: center;">
                <div class="flex" style="gap:10px; flex-wrap: wrap;">
                  <div><b>{{ q.label or q.qid }}</b></div>
                  <div><code>{{ q.type }}</code></div>
                  {% if score is not none and mx is not none %}
                    <span class="pill {{ 'ok' if ok else 'bad' }}">得分 {{ score }}/{{ mx }}</span>
                  {% endif %}
                </div>
              </div>

              <div class="md" style="margin-top:8px;">{{ q.stem_md | md }}</div>

              {% if q.type in ['single','multiple'] and q.options %}
                <div style="margin-top:10px; display:grid; gap:6px;">
                  {% set chosen = q.answer %}
                  {% if chosen is string %}
                    {% set chosen_list = [chosen] %}
                  {% elif chosen is iterable %}
                    {% set chosen_list = chosen %}
                  {% else %}
                    {% set chosen_list = [] %}
                  {% endif %}
                  {% for o in q.options %}
                    {% set is_chosen = o.key in chosen_list %}
                    {% set is_correct = o.correct %}
                    {% set cls = '' %}
                    {% if is_correct %}{% set cls = 'ok' %}{% endif %}
                    {% if is_chosen and not is_correct %}{% set cls = 'bad' %}{% endif %}
                    <div class="opt {{ cls }}">
                      <div style="min-width: 26px;"><b>{{ o.key }})</b></div>
                      <div style="flex:1;">{{ o.text }}</div>
                      {% if is_correct %}<span class="pill ok">正确</span>{% endif %}
                      {% if is_chosen and not is_correct %}<span class="pill bad">选错</span>{% endif %}
                      {% if is_chosen and is_correct %}<span class="pill ok">选对</span>{% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              {% if q.type == 'short' %}
                <div class="ans">
                  <div class="sub" style="margin:0 0 6px;">候选者答案</div>
                  <pre class="code">{{ q.answer or "" }}</pre>
                  {% if q.reason %}
                    <div class="sub" style="margin-top:10px;">判分要点</div>
                    <div class="sub" style="margin-top:6px; color: var(--text);">{{ q.reason }}</div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </section>
      </div>
    </main>
  </body>
</html>
