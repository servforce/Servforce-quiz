<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>答题回看</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='ui.css') }}" />
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [["$", "$"], ["\\(", "\\)"]],
          displayMath: [["$$", "$$"], ["\\[", "\\]"]],
        },
        options: { skipHtmlTags: ["script", "noscript", "style", "textarea", "pre", "code"] },
      };
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
      .md { white-space: normal; }
      .md img { max-width: 100%; height: auto; border-radius: 10px; display:block; margin: 10px 0; }

      /* Review cards: visually align with the exam question cards in ui.css. */
      .q {
        position: relative;
        border: 1px solid rgba(15, 23, 42, 0.10);
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.92);
        box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04);
        overflow: hidden;
        padding: 14px 14px 16px;
        margin: 14px 0;
      }
      .q::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: rgba(37, 99, 235, 0.55);
      }
      .q > .flex {
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      }
      .q .md { margin-top: 12px !important; line-height: 1.75; }
      .q > div[style*="display:grid"] { gap: 10px !important; }

      .q code {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(37, 99, 235, 0.26);
        background: rgba(37, 99, 235, 0.10);
        color: #1d4ed8;
        font-weight: 900;
        font-size: 12px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 900;
        font-size: 12px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.92);
        white-space: nowrap;
      }
      .pill.ok { border-color: rgba(22, 163, 74, 0.30); color: #166534; background: rgba(22, 163, 74, 0.10); }
      .pill.bad { border-color: rgba(220, 38, 38, 0.25); color: #991b1b; background: rgba(220, 38, 38, 0.08); }

      .opt {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid rgba(15, 23, 42, 0.10);
        background: rgba(255, 255, 255, 0.92);
      }
      .opt.ok { border-color: rgba(22, 163, 74, 0.26); background: rgba(22, 163, 74, 0.06); }
      .opt.bad { border-color: rgba(220, 38, 38, 0.22); background: rgba(220, 38, 38, 0.05); }
      .opt > div:first-child b {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 34px;
        height: 26px;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.10);
        background: rgba(15, 23, 42, 0.03);
        font-weight: 950;
        color: rgba(15, 23, 42, 0.86);
      }

      .ans {
        margin-top: 14px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        border-radius: 16px;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.92);
      }
      pre.code { white-space: pre-wrap; margin: 0; line-height: 1.7; }

      /* Font scale for review page (especially the header area). */
      .review-page { font-size: 16px; }
      .review-page .section-head .title { font-size: 26px; }
      .review-page .section-head .sub { font-size: 17px; }
      .review-page .section-head .sub code { font-size: 16px; padding: 4px 10px; }

      .review-page .q { font-size: 16px; }
      .review-page .q .md { font-size: 16px; }
      .review-page .opt { font-size: 16px; }
      .review-page .pill { font-size: 13px; padding: 6px 12px; }
      .review-page .q code { font-size: 13px; padding: 5px 12px; }

      .review-page .section-head .btn {
        font-size: 16px;
        padding: 12px 18px;
        border-radius: 14px;
      }
    </style>
  </head>
  <body class="review-page">
    <header class="topbar">
      <div class="container topbar-inner exam-frame">
        <div class="brand" aria-label="Servforce Quiz 管理后台">
          <span class="brand-badge" aria-hidden="true"></span>
          <span>Servforce Quiz</span>
        </div>
        <nav class="nav" aria-label="主导航">
          <a class="nav-link" href="/admin#tab-exams"><span class="nav-ico exams" aria-hidden="true"></span>试卷管理</a>
          <a class="nav-link" href="/admin/candidates"><span class="nav-ico candidates" aria-hidden="true"></span>候选人管理</a>
          <a class="nav-link active" href="/admin#tab-assign"><span class="nav-ico assign" aria-hidden="true"></span>答题邀请</a>
          <a class="nav-link" href="/admin#tab-logs"><span class="nav-ico logs" aria-hidden="true"></span>系统日志</a>
          {% set _ss = system_status_summary if system_status_summary else {} %}
          {% set _lvl = _ss.overall_level if _ss and _ss.overall_level else 'ok' %}
          {% set _badge = '' %}
          {% set _r_llm = ((_ss.get('llm') or {}).get('ratio') or 0.0) if _ss else 0.0 %}
          {% set _r_sms = ((_ss.get('sms') or {}).get('ratio') or 0.0) if _ss else 0.0 %}
          {% set _r_max = _r_llm if _r_llm > _r_sms else _r_sms %}
          {% set _pct = (_r_max * 100) | round(0) | int %}
          {% if _pct > 100 %}{% set _pct = 100 %}{% endif %}
          {% if _lvl != 'ok' %}{% set _badge = _pct ~ '%' %}{% endif %}
          <a class="nav-link" href="/admin#tab-status"><span class="nav-ico status" aria-hidden="true"></span>系统状态
            <span class="status-badge level-{{ _lvl }}" data-system-status-badge>{{ _badge }}</span>
          </a>
        </nav>
        <form method="post" action="/admin/logout" style="margin:0;">
          <button class="btn btn-danger" type="submit">退出</button>
        </form>
      </div>
    </header>

    <main class="container page exam-frame">
      {% for m in get_flashed_messages() %}
      {% if m and (m|string)|trim %}
      <div class="flash error">{{ m }}</div>
      {% endif %}
      {% endfor %}

      <div class="surface" role="region" aria-label="答题回看">
        <section class="section">
          <div class="section-head">
            <div>
              <h2 class="title">答题回看</h2>
              <p class="sub">
                候选者：<code>{{ archive.candidate.name }}</code> <code>{{ archive.candidate.phone }}</code>
                · 试卷：<code>{{ archive.exam.exam_key }}</code>
                {% if archive.total_score is not none %}
                  · 总分：<b>{{ archive.total_score }}</b>/100
                {% endif %}
              </p>
            </div>
            <a
              class="btn btn-primary"
              href="{{ back_url or '/admin#tab-assign' }}"
              onclick="if (window.history && history.length > 1) { history.back(); return false; }"
            >返回</a>
          </div>
        </section>

        <section class="section">
          {% set type_label_map = {'single':'单选','multiple':'多选','short':'简答'} %}
          {% for q in archive.questions %}
            {% set score = q.score %}
            {% set mx = q.score_max %}
            {% set ok = (score is not none and mx is not none and (score|int) >= (mx|int)) %}
            <div class="q {{ 'ok' if ok else 'bad' }}">
              <div class="flex" style="justify-content: space-between; align-items: center;">
                <div class="flex" style="gap:10px; flex-wrap: wrap;">
                  <div><b>{{ q.label or q.qid }}</b></div>
                  <div><code>{{ type_label_map.get(q.type, q.type) }}</code></div>
                  {% if mx is not none %}<span class="pill">{{ mx }}分</span>{% endif %}
                  {% if score is not none and mx is not none %}
                    <span class="pill {{ 'ok' if ok else 'bad' }}">得分 {{ score }}/{{ mx }}</span>
                  {% endif %}
                </div>
              </div>

              <div class="md" style="margin-top:8px;">{{ q.stem_md | md }}</div>

              {% if q.type in ['single','multiple'] and q.options %}
                <div style="margin-top:10px; display:grid; gap:6px;">
                  {% set chosen = q.answer %}
                  {% if chosen is string %}
                    {% set chosen_list = [chosen] %}
                  {% elif chosen is iterable %}
                    {% set chosen_list = chosen %}
                  {% else %}
                    {% set chosen_list = [] %}
                  {% endif %}
                  {% for o in q.options %}
                    {% set is_chosen = o.key in chosen_list %}
                    {% set is_correct = o.correct %}
                    {% set cls = '' %}
                    {% if is_correct %}{% set cls = 'ok' %}{% endif %}
                    {% if is_chosen and not is_correct %}{% set cls = 'bad' %}{% endif %}
                    <div class="opt {{ cls }}">
                      <div style="min-width: 26px;"><b>{{ o.key }}</b></div>
                      <div style="flex:1;">{{ o.text }}</div>
                      {% if is_correct %}<span class="pill ok">正确</span>{% endif %}
                      {% if is_chosen and not is_correct %}<span class="pill bad">选错</span>{% endif %}
                      {% if is_chosen and is_correct %}<span class="pill ok">选对</span>{% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              {% if q.type == 'short' %}
                <div class="ans">
                  <div class="sub" style="margin:0 0 6px;">候选者答案</div>
                  <pre class="code">{{ q.answer or "" }}</pre>
                  {% if q.reason %}
                    <div class="sub" style="margin-top:10px;">判分要点</div>
                    <div class="sub" style="margin-top:6px; color: var(--text);">{{ q.reason }}</div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </section>
      </div>
    </main>
    <script src="{{ url_for('static', filename='system_status.js') }}"></script>
  </body>
</html>
