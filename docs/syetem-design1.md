# 基于 Markdown（QML）在线能力测试系统（JSON 优先）设计文档

> 约束：**只参考 `qml.md`**；除“候选人列表”外尽量不使用数据库——试卷解析内容、答题数据、判分结果等都落到 **JSON 文件** 中；HTTP 使用 **Flask（Python）**；管理员可上传 Markdown 试卷并生成候选人唯一链接/二维码；候选人身份验证后在线作答；系统自动判分（客观题）+ 大模型判分（简答题）得到总分并给出是否进入面试建议。

---

## 1. 角色与业务流程

### 1.1 角色
- **管理员**：登录后台；上传 QML（Markdown）试卷；创建候选人（入库到 PostgreSQL 候选人列表）；为候选人生成唯一答题链接/二维码；查看进度与成绩。
- **候选人**：通过唯一链接进入；输入姓名/手机号完成身份验证；在线作答并提交（或到时自动交卷）。
- **系统**：解析 QML → 生成 `spec.json`；控制尝试次数/计时；判分（客观题对比正确答案；简答题调用 LLM 依据 rubric 评分）；汇总总分并生成决策。

### 1.2 流程（对应需求 1~3）
1) 管理员登录 → 上传 `*.md` 试卷 → 立即解析（QML）→ 将题号/类型/分数/题目/选项/正确答案/评分标准写入 `spec.json`  
2) 管理员在后台为候选人录入个人信息（写入 PostgreSQL 候选人表）→ 为候选人生成唯一 token（写入 `assignment.json`）→ 生成链接/二维码并发送  
3) 候选人打开链接 → 输入姓名/手机号与 DB 比对（完全一致通过）  
   - 失败：累加尝试次数，达到最大次数则 token 失效（`assignment.locked=true`）  
   - 通过：进入答题页，开始计时，提交或超时自动交卷  
4) 收卷后：  
   - 客观题：从 `spec.json` 取正确答案与候选人答案比对，正确得满分、错误 0  
   - 简答题：从 `spec.json` 取 rubric（评分标准）+ 候选人答案组装 prompt 发送给 LLM，得到分数与理由  
   - 汇总主客观得分 → 与阈值比较 → 给出“进入面试/不进入面试”建议

---

## 2. 试卷格式（QML）与解析要点（来自 `qml.md`）

### 2.1 QML 题目头
二级标题开头：
```
## Q<编号> [single|multiple|short] (分数可选) {属性可选}
```
类型：
- `single`：单选题
- `multiple`：多选题（可选 `{partial=true}`）
- `short`：简答题（建议 `{max=10}` 指定满分）

### 2.2 选项与正确答案标记
- 选项使用无序列表：`- A) 文本`
- 正确选项在字母后加 `*`：`- B*) 文本`
- `multiple` 题可能有多个 `*`

### 2.3 简答题 rubric 与 LLM 配置
- rubric：
  - `[rubric]...[/rubric]`
- 题目级 LLM（覆盖全局）：
  - `[llm] key=value ... [/llm]`；若没有 `key=` 则整段作为 `prompt_template`

---

## 3. 存储设计（JSON 优先 + PostgreSQL 仅候选人）

### 3.1 文件系统目录结构（建议）
```
storage/
  exams/
    {exam_key}/
      source.md                 # 原始上传的 Markdown
      spec.json                 # QML 解析后的结构化试卷（含正确答案/rubric）
      public.json               # 候选人视角试卷（不含正确答案/rubric）
  assignments/
    {token}.json                # token 对应一次答题实例（身份验证、计时、答案、判分）
  qr/
    {token}.png                 # token 对应二维码（可缓存）
```

### 3.2 JSON 文件写入原则
- **强一致写入**：使用“写临时文件 → 原子替换”的方式避免写一半损坏（Windows 可用 `os.replace`）。
- **并发锁**：对 `assignments/{token}.json` 进行文件锁，防止并发写导致覆盖。
- **审计可追溯**：`spec.json` 一经发布建议不改；若要更新则递增版本并新建目录或在 JSON 中保存 `version`。

